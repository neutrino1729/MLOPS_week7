name: CI/CD Pipeline with Load Testing
on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: theta-index-472515-d8
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1-a
  DEPLOYMENT_NAME: iris-api
  IMAGE: iris-api
  REPOSITORY: iris-repo
  NAMESPACE: iris-classifier

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Authenticate GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ---- make gsutil see the key (optional if you switch to the action) ----
      - name: Export ADC for gsutil
        run: |
          echo "$GCP_SA_KEY" > /tmp/key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/key.json
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      # ---- preferred way: use the official GCS action ----
      - name: Get Model from GCS
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: gs://mlops-course-dulcet-bastion-452612-v4-unique/my-models/feature-store-week-3/model.joblib
          destination: model.joblib   # local file

      # (or keep the gsutil line if you prefer)
      # - name: Get Model from GCS
      #   run: |
      #     gsutil cp gs://mlops-course-dulcet-bastion-452612-v4-unique/my-models/feature-store-week-3/model.joblib .

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Image
        run: |
          docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest .
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest

      # …rest of your steps unchanged…
