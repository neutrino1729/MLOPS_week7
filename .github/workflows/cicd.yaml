name: CI/CD Pipeline with Load Testing

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: theta-index-472515-d8
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1-a
  DEPLOYMENT_NAME: iris-api
  IMAGE: iris-api
  REPOSITORY: iris-repo
  NAMESPACE: iris-classifier
  MODEL_GCS_PATH: gs://mlops-course-dulcet-bastion-452612-v4-unique/my-models/feature-store-week-3/model.joblib

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Download Model from GCS
        run: |
          echo "Verifying GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "Verifying access to GCS bucket..."
          gcloud storage ls gs://mlops-course-dulcet-bastion-452612-v4-unique/my-models/feature-store-week-3/ || \
            { echo "Failed to list directory. Check IAM or bucket existence."; exit 1; }
          
          echo "Downloading model: $MODEL_GCS_PATH"
          gcloud storage cp "$MODEL_GCS_PATH" ./model.joblib
          
          echo "Model downloaded successfully:"
          ls -lh model.joblib
          file model.joblib
          du -h model.joblib

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest
          echo "Building image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          echo "Pushing image..."
          docker push $IMAGE_TAG
          echo "Image pushed successfully."

      - name: Get GKE Cluster Credentials
        run: |
          # Install gke-gcloud-auth-plugin (fixes kubectl auth)
          gcloud components install gke-gcloud-auth-plugin --quiet
          
          # Get credentials (plugin now handles auth)
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE --project $PROJECT_ID

      - name: Deploy Kubernetes Resources
        run: |
          echo "Applying Kubernetes manifests..."
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml
          
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=5m

      - name: Get LoadBalancer External IP
        id: ip
        run: |
          echo "Waiting for LoadBalancer IP (up to 10 minutes)..."
          for i in {1..60}; do
            IP=$(kubectl get svc iris-api-service -n $NAMESPACE \
                 -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [[ -n "$IP" ]]; then
              echo "ip=$IP" >> $GITHUB_OUTPUT
              echo "External IP assigned: $IP"
              break
            fi
            echo "Attempt $i: IP not ready. Sleeping 10s..."
            sleep 10
          done
          if [[ -z "$IP" ]]; then
            echo "Failed to get external IP after 10 minutes"
            exit 1
          fi

      - name: Install wrk (Load Testing Tool)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wrk

      - name: Create wrk Lua Script for POST Request
        run: |
          cat > post.lua <<'EOF'
          wrk.method = "POST"
          wrk.body   = '{"sepal_length": 5.1, "sepal_width": 3.5, "petal_length": 1.4, "petal_width": 0.2}'
          wrk.headers["Content-Type"] = "application/json"
          EOF
          echo "post.lua created."

      - name: Load Test 1 – 1000 Connections (1 Pod)
        run: |
          echo "Scaling deployment to 1 replica..."
          kubectl scale deployment/$DEPLOYMENT_NAME --replicas=1 -n $NAMESPACE
          sleep 30
          
          echo "Starting load test: 1000 connections, 8 threads, 30s"
          wrk -t8 -c1000 -d30s -s post.lua http://${{ steps.ip.outputs.ip }}/predict/

      - name: Load Test 2 – 2000 Connections (HPA Scaling Test)
        run: |
          echo "Starting HPA scaling test: 2000 connections, 12 threads, 60s"
          wrk -t12 -c2000 -d60s -s post.lua http://${{ steps.ip.outputs.ip }}/predict/ || true
          
          echo "=== Final Pod Status ==="
          kubectl get pods -n $NAMESPACE -o wide
          
          echo "=== HPA Status ==="
          kubectl get hpa -n $NAMESPACE
          
          echo "=== Resource Usage ==="
          kubectl top pods -n $NAMESPACE || echo "kubectl top not available"
