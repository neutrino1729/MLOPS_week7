name: CI/CD Debug for GCS access
on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  PROJECT_ID: theta-index-472515-d8
  BUCKET: mlops-course-dulcet-bastion-452612-v4-unique
  MODEL_PATH: my-models/feature-store-week-3/model.joblib

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup gcloud (explicit project)
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Authenticate to GCP (Service Account Key)
      if: ${{ secrets.GCP_SA_KEY != '' }}
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Debug: show identity & test access
      run: |
        echo "---- gcloud auth list ----"
        gcloud auth list || true

        echo "---- gcloud config ----"
        gcloud config list --format="yaml" || true

        echo "---- whoami (curl metadata) ----"
        # this will only work on GCP VM, but harmless otherwise
        curl -s -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/email || true

        echo "---- gsutil version ----"
        gsutil version -l || true

        echo "---- Try listing object metadata ----"
        gsutil ls -L gs://$BUCKET/$MODEL_PATH || true

        echo "---- Try cp (dry-run) ----"
        gsutil cp -n gs://$BUCKET/$MODEL_PATH . || true

    - name: Get Model from GCS (final attempt)
      run: |
        echo "Attempting final cp..."
        gsutil cp gs://$BUCKET/$MODEL_PATH .
