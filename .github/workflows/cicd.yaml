name: CI/CD Pipeline with Load Testing

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: theta-index-472515-d8
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1-a
  DEPLOYMENT_NAME: iris-api
  IMAGE: iris-api
  REPOSITORY: iris-repo
  NAMESPACE: iris-classifier
  MODEL_GCS_PATH: gs://mlops-course-dulcet-bastion-452612-v4-unique/my-models/feature-store-week-3/model.joblib

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # needed for workload identity (optional, kept for future)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4   # v4 is stable on 2025 runners

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ---- Export ADC so gsutil can use the key ----
      - name: Export GCP Credentials for gsutil
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > $HOME/gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-key.json" >> $GITHUB_ENV

      # ---- Download model using gsutil (guaranteed to work) ----
      - name: Download Model from GCS
        run: |
          echo "Downloading model from $MODEL_GCS_PATH ..."
          gsutil cp "$MODEL_GCS_PATH" ./model.joblib
          echo "Model downloaded:"
          ls -lh model.joblib

      # ---- Optional: verify file integrity (size, type) ----
      - name: Verify Model File
        run: |
          file model.joblib
          du -h model.joblib

      # ---- Configure Docker for Artifact Registry ----
      - name: Configure Docker Auth
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      # ---- Build & Push Container Image ----
      - name: Build and Push Image
        run: |
          IMAGE_TAG=us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

      # ---- Get GKE Credentials ----
      - name: Fetch GKE Cluster Credentials
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE --project $PROJECT_ID

      # ---- Apply Kubernetes Manifests ----
      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=5m

      # ---- Wait for External IP ----
      - name: Get LoadBalancer IP
        id: ip
        run: |
          echo "Waiting for LoadBalancer IP (max 10 min)..."
          for i in {1..60}; do
            IP=$(kubectl get svc iris-api-service -n $NAMESPACE \
                 -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [[ -n "$IP" ]]; then
              echo "ip=$IP" >> $GITHUB_OUTPUT
              echo "External IP: $IP"
              exit 0
            fi
            echo "Attempt $i: IP not ready, sleeping 10s..."
            sleep 10
          done
          echo "Timed out waiting for IP"
          exit 1

      # ---- Install wrk for load testing ----
      - name: Install wrk
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wrk

      # ---- Create Lua script for POST body ----
      - name: Create POST Lua Script
        run: |
          cat > post.lua <<'EOF'
          wrk.method = "POST"
          wrk.body   = '{"sepal_length": 5.1, "sepal_width": 3.5, "petal_length": 1.4, "petal_width": 0.2}'
          wrk.headers["Content-Type"] = "application/json"
          EOF

      # ---- Load Test 1: 1000 connections, 1 pod ----
      - name: Load Test – 1000 Connections (1 Pod)
        run: |
          kubectl scale deployment/$DEPLOYMENT_NAME --replicas=1 -n $NAMESPACE
          sleep 30
          echo "Running wrk: 8 threads, 1000 connections, 30s"
          wrk -t8 -c1000 -d30s -s post.lua http://${{ steps.ip.outputs.ip }}/predict/

      # ---- Load Test 2: 2000 connections (HPA trigger) ----
      - name: Load Test – 2000 Connections (HPA Scaling)
        run: |
          echo "Running wrk: 12 threads, 2000 connections, 60s"
          wrk -t12 -c2000 -d60s -s post.lua http://${{ steps.ip.outputs.ip }}/predict/ || true
          echo "=== Pod status ==="
          kubectl get pods -n $NAMESPACE -o wide
          echo "=== HPA status ==="
          kubectl get hpa -n $NAMESPACE
          echo "=== Resource usage ==="
          kubectl top pods -n $NAMESPACE
